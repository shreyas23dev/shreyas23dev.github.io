import React, { useState } from 'react';
import { BarChart, Bar, LineChart, Line, ScatterChart, Scatter, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, Cell } from 'recharts';
import { TrendingUp, TrendingDown, Clock, Shield, Target, Activity } from 'lucide-react';

const PSSSSecurityDashboard = () => {
  const [timeRange, setTimeRange] = useState('90days');
  const [selectedCVE, setSelectedCVE] = useState(null);

  const vulnerabilities = [
    { cve_id: 'CVE-2024-1001', cvss: 9.8, epss: 0.85, psss: 0.92, attack: 1, tactic: 'Initial Access', daysOpen: 5, assets: 'Web Servers' },
    { cve_id: 'CVE-2024-1002', cvss: 7.5, epss: 0.92, psss: 0.88, attack: 1, tactic: 'Initial Access', daysOpen: 12, assets: 'Database' },
    { cve_id: 'CVE-2024-1003', cvss: 8.8, epss: 0.75, psss: 0.85, attack: 1, tactic: 'Privilege Escalation', daysOpen: 3, assets: 'API Gateway' },
    { cve_id: 'CVE-2024-1004', cvss: 6.5, epss: 0.45, psss: 0.58, attack: 0, tactic: 'Defense Evasion', daysOpen: 45, assets: 'Workstations' },
    { cve_id: 'CVE-2024-1005', cvss: 9.1, epss: 0.68, psss: 0.82, attack: 1, tactic: 'Lateral Movement', daysOpen: 8, assets: 'Domain Controllers' },
    { cve_id: 'CVE-2024-1006', cvss: 5.3, epss: 0.88, psss: 0.75, attack: 1, tactic: 'Initial Access', daysOpen: 20, assets: 'VPN Gateway' },
    { cve_id: 'CVE-2024-1007', cvss: 7.2, epss: 0.32, psss: 0.55, attack: 0, tactic: 'Execution', daysOpen: 60, assets: 'Email Servers' },
    { cve_id: 'CVE-2024-1008', cvss: 8.1, epss: 0.55, psss: 0.71, attack: 1, tactic: 'Persistence', daysOpen: 15, assets: 'Cloud Infrastructure' },
  ];

  const overallPSSS = (vulnerabilities.reduce((sum, v) => sum + v.psss, 0) / vulnerabilities.length * 10).toFixed(1);
  const criticalCount = vulnerabilities.filter(v => v.psss >= 0.8).length;
  const highCount = vulnerabilities.filter(v => v.psss >= 0.6 && v.psss < 0.8).length;
  const mediumCount = vulnerabilities.filter(v => v.psss >= 0.4 && v.psss < 0.6).length;
  const lowCount = vulnerabilities.filter(v => v.psss < 0.4).length;

  const mttrCritical = vulnerabilities.filter(v => v.psss >= 0.8).reduce((sum, v) => sum + v.daysOpen, 0) / criticalCount || 0;
  const mttrHigh = vulnerabilities.filter(v => v.psss >= 0.6 && v.psss < 0.8).reduce((sum, v) => sum + v.daysOpen, 0) / highCount || 0;
  const mttrAll = vulnerabilities.reduce((sum, v) => sum + v.daysOpen, 0) / vulnerabilities.length;

  const trendData = [
    { day: 'Day 1', discovered: 5, closed: 2 },
    { day: 'Day 7', discovered: 8, closed: 6 },
    { day: 'Day 14', discovered: 12, closed: 10 },
    { day: 'Day 21', discovered: 15, closed: 14 },
    { day: 'Day 30', discovered: 18, closed: 18 },
    { day: 'Day 60', discovered: 22, closed: 23 },
    { day: 'Day 90', discovered: 25, closed: 26 },
  ];

  const backlogData = [
    { priority: 'Critical', count: criticalCount, color: '#dc2626' },
    { priority: 'High', count: highCount, color: '#f97316' },
    { priority: 'Medium', count: mediumCount, color: '#eab308' },
    { priority: 'Low', count: lowCount, color: '#22c55e' },
  ];

  const tacticData = Object.entries(
    vulnerabilities.reduce((acc, v) => {
      acc[v.tactic] = (acc[v.tactic] || 0) + 1;
      return acc;
    }, {})
  ).map(([name, value]) => ({ name, value }));

  const topVulns = [...vulnerabilities].sort((a, b) => b.psss - a.psss).slice(0, 5);

  const scatterData = vulnerabilities.map(v => ({
    ...v,
    epssPercent: v.epss * 100,
    psssSize: v.psss * 20
  }));

  const getScatterColor = (psss) => {
    if (psss >= 0.8) return '#dc2626';
    if (psss >= 0.6) return '#f97316';
    if (psss >= 0.4) return '#eab308';
    return '#22c55e';
  };

  const getRiskColor = (score) => {
    if (score >= 8) return 'bg-red-500';
    if (score >= 6) return 'bg-orange-500';
    if (score >= 4) return 'bg-yellow-500';
    return 'bg-green-500';
  };

  const attributionData = topVulns.map(v => ({
    cve: v.cve_id,
    cvss_norm: (v.cvss / 10) * 0.4,
    epss: v.epss * 0.4,
    attack_boost: v.attack * 0.2
  }));

  const comparisonData = topVulns.map(v => ({
    cve: v.cve_id,
    CVSS: v.cvss / 10,
    EPSS: v.epss,
    PSSS: v.psss
  }));

  return (
    <div className="min-h-screen bg-gray-900 text-white p-6">
      <div className="mb-8">
        <div className="flex items-center justify-between mb-4">
          <div className="flex items-center gap-3">
            <Shield className="w-10 h-10 text-blue-400" />
            <h1 className="text-3xl font-bold">Predictive Risk Center</h1>
          </div>
          <div className="flex gap-4 items-center">
            <div className="text-sm text-gray-400">
              Last Updated: {new Date().toLocaleString()}
            </div>
            <select 
              className="bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm"
              value={timeRange}
              onChange={(e) => setTimeRange(e.target.value)}
            >
              <option value="7days">Last 7 Days</option>
              <option value="30days">Last 30 Days</option>
              <option value="90days">Last 90 Days</option>
            </select>
          </div>
        </div>
      </div>

      <div className="mb-8">
        <h2 className="text-2xl font-bold mb-4 flex items-center gap-2">
          <Activity className="w-6 h-6 text-blue-400" />
          Sentinel: Executive Summary
        </h2>
        
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <div className="flex items-center justify-between mb-2">
              <h3 className="text-sm text-gray-400">Overall PSSS Risk</h3>
              <TrendingDown className="w-4 h-4 text-green-400" />
            </div>
            <div className="flex items-end gap-2">
              <span className="text-4xl font-bold">{overallPSSS}</span>
              <span className="text-gray-400 mb-1">/10</span>
            </div>
            <div className={`mt-3 h-2 rounded-full ${getRiskColor(parseFloat(overallPSSS))}`}></div>
            <div className="mt-2 text-xs text-green-400">↓ 0.3 vs last week</div>
          </div>

          <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <div className="flex items-center gap-2 mb-2">
              <Clock className="w-4 h-4 text-red-400" />
              <h3 className="text-sm text-gray-400">MTTR (Critical)</h3>
            </div>
            <div className="text-3xl font-bold">{mttrCritical.toFixed(1)}</div>
            <div className="text-xs text-gray-400 mt-1">days</div>
            <div className="mt-2 text-xs text-red-400">↑ 12% vs last period</div>
          </div>

          <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <div className="flex items-center gap-2 mb-2">
              <Clock className="w-4 h-4 text-orange-400" />
              <h3 className="text-sm text-gray-400">MTTR (High)</h3>
            </div>
            <div className="text-3xl font-bold">{mttrHigh.toFixed(1)}</div>
            <div className="text-xs text-gray-400 mt-1">days</div>
            <div className="mt-2 text-xs text-green-400">↓ 5% vs last period</div>
          </div>

          <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <div className="flex items-center gap-2 mb-2">
              <Clock className="w-4 h-4 text-blue-400" />
              <h3 className="text-sm text-gray-400">MTTR (All)</h3>
            </div>
            <div className="text-3xl font-bold">{mttrAll.toFixed(1)}</div>
            <div className="text-xs text-gray-400 mt-1">days</div>
            <div className="mt-2 text-xs text-green-400">↓ 8% vs last period</div>
          </div>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h3 className="text-lg font-semibold mb-4">Remediation Rate Trend (90 Days)</h3>
            <ResponsiveContainer width="100%" height={250}>
              <LineChart data={trendData}>
                <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                <XAxis dataKey="day" stroke="#9ca3af" />
                <YAxis stroke="#9ca3af" />
                <Tooltip 
                  contentStyle={{ backgroundColor: '#1f2937', border: '1px solid #374151' }}
                  labelStyle={{ color: '#fff' }}
                />
                <Legend />
                <Line type="monotone" dataKey="discovered" stroke="#f97316" strokeWidth={2} name="Discovered" />
                <Line type="monotone" dataKey="closed" stroke="#22c55e" strokeWidth={2} name="Closed" />
              </LineChart>
            </ResponsiveContainer>
          </div>

          <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h3 className="text-lg font-semibold mb-4">PSSS-Prioritized Backlog</h3>
            <ResponsiveContainer width="100%" height={250}>
              <BarChart data={backlogData}>
                <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                <XAxis dataKey="priority" stroke="#9ca3af" />
                <YAxis stroke="#9ca3af" />
                <Tooltip 
                  contentStyle={{ backgroundColor: '#1f2937', border: '1px solid #374151' }}
                  labelStyle={{ color: '#fff' }}
                />
                <Bar dataKey="count" name="Vulnerabilities">
                  {backlogData.map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={entry.color} />
                  ))}
                </Bar>
              </BarChart>
            </ResponsiveContainer>
          </div>
        </div>
      </div>

      <div className="mb-8">
        <h2 className="text-2xl font-bold mb-4 flex items-center gap-2">
          <Target className="w-6 h-6 text-orange-400" />
          Triage Matrix: Actionable Prioritization
        </h2>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div className="lg:col-span-2 bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h3 className="text-lg font-semibold mb-4">PSSS Prioritization Matrix (The "Sweet Spot")</h3>
            <ResponsiveContainer width="100%" height={400}>
              <ScatterChart>
                <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                <XAxis 
                  type="number" 
                  dataKey="epssPercent" 
                  name="EPSS %" 
                  stroke="#9ca3af"
                  label={{ value: 'EPSS (Exploit Probability %)', position: 'insideBottom', offset: -5, fill: '#9ca3af' }}
                />
                <YAxis 
                  type="number" 
                  dataKey="cvss" 
                  name="CVSS" 
                  stroke="#9ca3af"
                  label={{ value: 'CVSS Severity', angle: -90, position: 'insideLeft', fill: '#9ca3af' }}
                />
                <Tooltip 
                  cursor={{ strokeDasharray: '3 3' }}
                  contentStyle={{ backgroundColor: '#1f2937', border: '1px solid #374151' }}
                  labelStyle={{ color: '#fff' }}
                  content={({ payload }) => {
                    if (payload && payload.length > 0) {
                      const data = payload[0].payload;
                      return (
                        <div className="bg-gray-800 border border-gray-700 p-3 rounded">
                          <div className="font-bold text-blue-400">{data.cve_id}</div>
                          <div className="text-sm mt-1">CVSS: {data.cvss}</div>
                          <div className="text-sm">EPSS: {(data.epss * 100).toFixed(1)}%</div>
                          <div className="text-sm font-bold text-orange-400">PSSS: {data.psss.toFixed(2)}</div>
                          <div className="text-sm">Assets: {data.assets}</div>
                        </div>
                      );
                    }
                    return null;
                  }}
                />
                <Scatter 
                  data={scatterData} 
                  onClick={(data) => setSelectedCVE(data)}
                >
                  {scatterData.map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={getScatterColor(entry.psss)} />
                  ))}
                </Scatter>
              </ScatterChart>
            </ResponsiveContainer>
            <div className="mt-4 flex gap-4 text-xs">
              <div className="flex items-center gap-2">
                <div className="w-3 h-3 rounded-full bg-red-600"></div>
                <span>Critical (≥0.8)</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-3 h-3 rounded-full bg-orange-500"></div>
                <span>High (0.6-0.8)</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-3 h-3 rounded-full bg-yellow-500"></div>
                <span>Medium (0.4-0.6)</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-3 h-3 rounded-full bg-green-500"></div>
                <span>Low (&lt;0.4)</span>
              </div>
            </div>
          </div>

          <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h3 className="text-lg font-semibold mb-4">ATT&CK Tactic Distribution</h3>
            <ResponsiveContainer width="100%" height={400}>
              <BarChart data={tacticData} layout="vertical">
                <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                <XAxis type="number" stroke="#9ca3af" />
                <YAxis dataKey="name" type="category" stroke="#9ca3af" width={120} />
                <Tooltip 
                  contentStyle={{ backgroundColor: '#1f2937', border: '1px solid #374151' }}
                  labelStyle={{ color: '#fff' }}
                />
                <Bar dataKey="value" fill="#3b82f6" name="Count" />
              </BarChart>
            </ResponsiveContainer>
          </div>
        </div>

        <div className="mt-6 bg-gray-800 rounded-lg p-6 border border-gray-700">
          <h3 className="text-lg font-semibold mb-4">Top Priority Action List</h3>
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="border-b border-gray-700">
                <tr className="text-left text-sm text-gray-400">
                  <th className="pb-3 font-medium">CVE ID</th>
                  <th className="pb-3 font-medium">PSSS Score</th>
                  <th className="pb-3 font-medium">CVSS</th>
                  <th className="pb-3 font-medium">EPSS</th>
                  <th className="pb-3 font-medium">ATT&CK</th>
                  <th className="pb-3 font-medium">Affected Assets</th>
                  <th className="pb-3 font-medium">Days Open</th>
                  <th className="pb-3 font-medium">Action</th>
                </tr>
              </thead>
              <tbody>
                {topVulns.map((vuln, idx) => (
                  <tr key={idx} className="border-b border-gray-700 hover:bg-gray-750">
                    <td className="py-3 font-mono text-blue-400">{vuln.cve_id}</td>
                    <td className="py-3">
                      <span className={`px-2 py-1 rounded text-xs font-bold ${
                        vuln.psss >= 0.8 ? 'bg-red-600' : vuln.psss >= 0.6 ? 'bg-orange-600' : 'bg-yellow-600'
                      }`}>
                        {vuln.psss.toFixed(2)}
                      </span>
                    </td>
                    <td className="py-3">{vuln.cvss}</td>
                    <td className="py-3">{(vuln.epss * 100).toFixed(1)}%</td>
                    <td className="py-3">{vuln.tactic}</td>
                    <td className="py-3 text-sm">{vuln.assets}</td>
                    <td className="py-3">{vuln.daysOpen}</td>
                    <td className="py-3">
                      <button className="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs">
                        Remediate
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div className="mb-8">
        <h2 className="text-2xl font-bold mb-4 flex items-center gap-2">
          <TrendingUp className="w-6 h-6 text-green-400" />
          Attribution: ML Model Insights
        </h2>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h3 className="text-lg font-semibold mb-4">PSSS Score Attribution (Top 5 CVEs)</h3>
            <ResponsiveContainer width="100%" height={300}>
              <BarChart data={attributionData} layout="vertical">
                <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                <XAxis type="number" stroke="#9ca3af" />
                <YAxis dataKey="cve" type="category" stroke="#9ca3af" width={100} />
                <Tooltip 
                  contentStyle={{ backgroundColor: '#1f2937', border: '1px solid #374151' }}
                  labelStyle={{ color: '#fff' }}
                />
                <Legend />
                <Bar dataKey="cvss_norm" stackId="a" fill="#3b82f6" name="CVSS (40%)" />
                <Bar dataKey="epss" stackId="a" fill="#f59e0b" name="EPSS (40%)" />
                <Bar dataKey="attack_boost" stackId="a" fill="#10b981" name="ATT&CK Boost (20%)" />
              </BarChart>
            </ResponsiveContainer>
          </div>

          <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h3 className="text-lg font-semibold mb-4">CVSS vs EPSS vs PSSS Comparison</h3>
            <ResponsiveContainer width="100%" height={300}>
              <BarChart data={comparisonData}>
                <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                <XAxis dataKey="cve" stroke="#9ca3af" angle={-45} textAnchor="end" height={80} />
                <YAxis stroke="#9ca3af" />
                <Tooltip 
                  contentStyle={{ backgroundColor: '#1f2937', border: '1px solid #374151' }}
                  labelStyle={{ color: '#fff' }}
                />
                <Legend />
                <Bar dataKey="CVSS" fill="#60a5fa" name="CVSS (Normalized)" />
                <Bar dataKey="EPSS" fill="#fb923c" name="EPSS" />
                <Bar dataKey="PSSS" fill="#34d399" name="PSSS" />
              </BarChart>
            </ResponsiveContainer>
          </div>
        </div>
      </div>

      {selectedCVE && (
        <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50" onClick={() => setSelectedCVE(null)}>
          <div className="bg-gray-800 rounded-lg p-6 max-w-lg border border-gray-700" onClick={e => e.stopPropagation()}>
            <div className="flex justify-between items-start mb-4">
              <h3 className="text-xl font-bold text-blue-400">{selectedCVE.cve_id}</h3>
              <button onClick={() => setSelectedCVE(null)} className="text-gray-400 hover:text-white">✕</button>
            </div>
            <div className="space-y-2 text-sm">
              <div className="flex justify-between">
                <span className="text-gray-400">PSSS Score:</span>
                <span className="font-bold text-orange-400">{selectedCVE.psss.toFixed(2)}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-400">CVSS Base:</span>
                <span>{selectedCVE.cvss}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-400">EPSS:</span>
                <span>{(selectedCVE.epss * 100).toFixed(1)}%</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-400">ATT&CK Tactic:</span>
                <span>{selectedCVE.tactic}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-400">Affected Assets:</span>
                <span>{selectedCVE.assets}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-400">Days Open:</span>
                <span className="text-red-400">{selectedCVE.daysOpen} days</span>
              </div>
            </div>
            <div className="mt-6 flex gap-3">
              <button className="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded">
                Assign to Team
              </button>
              <button className="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 rounded">
                Mark as Remediated
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default PSSSSecurityDashboard;
